<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Estimate Epidemiological Parameters from Wastewater Measurements • EpiSewer</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Estimate Epidemiological Parameters from Wastewater Measurements">
<meta name="description" content="What the package does (one paragraph).">
<meta property="og:description" content="What the package does (one paragraph).">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">EpiSewer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Introduction</h6></li>
    <li><a class="dropdown-item" href="articles/model-specification.html">Modeling in EpiSewer</a></li>
    <li><a class="dropdown-item" href="articles/detailed-example.html">Detailed example</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Modeling details</h6></li>
    <li><a class="dropdown-item" href="articles/model-definition.html">Model definition</a></li>
    <li><a class="dropdown-item" href="articles/load_per_case.html">The "shedding load per case" assumption</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/adrian-lison/EpiSewer/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><p><a href="https://adrian-lison.github.io/EpiSewer/"><img src="reference/figures/EpiSewer_logo.png" align="right" width="95" alt="EpiSewer package website"></a></p>
<div class="section level1">
<div class="page-header"><h1 id="episewer-estimate-epidemiological-parameters-from-wastewater-measurements">EpiSewer: Estimate Epidemiological Parameters from Wastewater Measurements<a class="anchor" aria-label="anchor" href="#episewer-estimate-epidemiological-parameters-from-wastewater-measurements"></a>
</h1></div>
<!-- badges: start -->

<div class="section level2">
<h2 id="about">About<a class="anchor" aria-label="anchor" href="#about"></a>
</h2>
<p>The <code>EpiSewer</code> R package provides a Bayesian generative model to estimate effective reproduction numbers and other epidemiological parameters from concentration measurements at a wastewater treatment plant (or other sampling site) over time. This allows to track the transmission dynamics of a pathogen in the associated catchment population. The <code>EpiSewer</code> model is tailored to the specifics of wastewater concentration measurements, offers comprehensive uncertainty quantification via MCMC sampling in <code>stan</code>, and provides easily configurable modeling components.</p>
<p><img src="reference/figures/weekly_zurich_animated.gif" width="100%"></p>
</div>
<div class="section level2">
<h2 id="model-highlights">Model highlights<a class="anchor" aria-label="anchor" href="#model-highlights"></a>
</h2>
<p><strong>Measurements</strong><br>
⭐ Non-daily / missing measurements<br>
⭐ Multiple measurements (replicates) per sample<br>
⭐ Multi-day composite samples<br>
⭐ Accurate dPCR noise model<br>
⭐ Limit of detection (LOD) model</p>
<p><strong>Sampling</strong><br>
⭐ Sample batch effects (e.g. weekday or age-of-sample effects)</p>
<p><strong>Sewer</strong><br>
⭐ Flow normalization<br>
⭐ Sewer residence time distributions</p>
<p><strong>Shedding</strong><br>
⭐ Incubation period and shedding load distributions<br>
⭐ Individual-level shedding load variation</p>
<p><strong>Infections</strong><br>
⭐ Stochastic infection model with overdispersion<br>
⭐ Flexible <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math> smoothing (random walk, exponential smoothing, splines)<br>
⭐ Transmission indicators: <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>, growth rate, doubling time, and more</p>
<p><strong>Forecast</strong><br>
⭐ Probabilistic forecasts of <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>, infections, concentrations and more</p>
</div>
<div class="section level2">
<h2 id="installing-the-package">Installing the package<a class="anchor" aria-label="anchor" href="#installing-the-package"></a>
</h2>
<p>The development version of <code>EpiSewer</code> can be installed from GitHub as shown below. Please note that the package is still highly experimental and may be subject to breaking changes.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"adrian-lison/EpiSewer"</span>, dependencies <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><code>EpiSewer</code> also requires CmdStan to be installed on your system. This can be done using the <code>install_cmdstan()</code> function from <code>cmdstanr</code>. If you experience any problems installing CmdStan, see the <a href="https://mc-stan.org/cmdstanr/articles/cmdstanr.html" class="external-link">cmdstanr vignette</a> for help.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cmdstanr</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/install_cmdstan.html" class="external-link">check_cmdstan_toolchain</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cmdstanr</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/install_cmdstan.html" class="external-link">install_cmdstan</a></span><span class="op">(</span>cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># use more cores to speed up</span></span></code></pre></div>
<p>The stan models used by EpiSewer need to be compiled for your device. This is only necessary once - after installing or updating the package - and can be done using the <code><a href="reference/sewer_compile.html">sewer_compile()</a></code> function.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">EpiSewer</span><span class="fu">::</span><span class="fu"><a href="reference/sewer_compile.html">sewer_compile</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>If the models are not successfully compiled, please ensure that <code>cmdstan</code> is properly set up and try updating it to a newer version using <code><a href="https://mc-stan.org/cmdstanr/reference/install_cmdstan.html" class="external-link">cmdstanr::install_cmdstan()</a></code>. If the problem persists, please run <code>EpiSewer::sewer_compile(verbose = TRUE)</code> and post the output in a new issue on GitHub, along with your <code><a href="https://mc-stan.org/cmdstanr/reference/set_cmdstan_path.html" class="external-link">cmdstanr::cmdstan_version()</a></code>.</p>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This is a quick introduction to using the <code>EpiSewer</code> package. To learn more about modeling with <code>EpiSewer</code>, see the <a href="https://adrian-lison.github.io/EpiSewer/articles/model-specification.html">model specification</a> and <a href="https://adrian-lison.github.io/EpiSewer/articles/detailed-example.html">detailed example</a> vignettes on the <a href="https://adrian-lison.github.io/EpiSewer/">package website</a>.</p>
<div class="section level3">
<h3 id="loading-the-package">Loading the package<a class="anchor" aria-label="anchor" href="#loading-the-package"></a>
</h3>
<p><code>EpiSewer</code> comes with <code>data.table</code> for data manipulation and <code>ggplot2</code> for plotting.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://adrian-lison.github.io/EpiSewer/">EpiSewer</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<div class="section level4">
<h4 id="data-requirements">Data requirements<a class="anchor" aria-label="anchor" href="#data-requirements"></a>
</h4>
<p>The below example of wastewater data is from Zurich, Switzerland. Data are provided by EAWAG (Swiss Federal Institute of Aquatic Science and Technology) to the public domain (CC BY 4.0 license).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_zurich</span> <span class="op">&lt;-</span> <span class="va">SARS_CoV_2_Zurich</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data_zurich</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "measurements" "flows"        "cases"        "units"</span></span></code></pre></div>
<ul>
<li>
<code>measurements</code>: <code>EpiSewer</code> requires a time series of concentration measurements. Measurements should ideally be in gc/mL (gc = gene copies).</li>
<li>
<code>flows</code>: Data about the daily wastewater volume flowing through the sampling site (should be in mL/day). Flow data is highly recommended, but not strictly necessary (see documentation of <code><a href="reference/flows_assume.html">flows_assume()</a></code>).</li>
<li>
<code>cases</code>: Data about confirmed cases in the catchment area. This is optional but can help informing some of our prior assumptions.</li>
</ul>
<div class="section level5">
<h5 id="measurements">Measurements<a class="anchor" aria-label="anchor" href="#measurements"></a>
</h5>
<p>The <code>measurements</code> data contains daily viral concentration measurements (in gc/mL) for the SARS-CoV-2 N1 gene at the wastewater treatment plant in Zurich. Some days have missing measurements, but this is no problem: <code>EpiSewer</code> naturally accounts for missing values during estimation.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_zurich</span><span class="op">$</span><span class="va">measurements</span></span>
<span><span class="co">#&gt;            date concentration</span></span>
<span><span class="co">#&gt;   1: 2022-01-01            NA</span></span>
<span><span class="co">#&gt;   2: 2022-01-02            NA</span></span>
<span><span class="co">#&gt;   3: 2022-01-03      455.7580</span></span>
<span><span class="co">#&gt;   4: 2022-01-04      747.8792</span></span>
<span><span class="co">#&gt;   5: 2022-01-05      573.7020</span></span>
<span><span class="co">#&gt;  ---                         </span></span>
<span><span class="co">#&gt; 116: 2022-04-26      182.3664</span></span>
<span><span class="co">#&gt; 117: 2022-04-27      379.2421</span></span>
<span><span class="co">#&gt; 118: 2022-04-28      439.7427</span></span>
<span><span class="co">#&gt; 119: 2022-04-29      394.0033</span></span>
<span><span class="co">#&gt; 120: 2022-04-30      293.1242</span></span></code></pre></div>
<p>To show the handling of missing data more clearly, we make our data artificially sparse by keeping only measurements that were made on <em>Mondays</em> and <em>Thursdays.</em> This means we will only have two measurements per week.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">measurements_sparse</span> <span class="op">&lt;-</span> <span class="va">data_zurich</span><span class="op">$</span><span class="va">measurements</span><span class="op">[</span>,<span class="va">weekday</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html" class="external-link">weekdays</a></span><span class="op">(</span><span class="va">data_zurich</span><span class="op">$</span><span class="va">measurements</span><span class="op">$</span><span class="va">date</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="va">weekday</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Monday"</span>,<span class="st">"Thursday"</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">measurements_sparse</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;           date concentration  weekday</span></span>
<span><span class="co">#&gt;  1: 2022-01-03      455.7580   Monday</span></span>
<span><span class="co">#&gt;  2: 2022-01-06      330.7298 Thursday</span></span>
<span><span class="co">#&gt;  3: 2022-01-10      387.6885   Monday</span></span>
<span><span class="co">#&gt;  4: 2022-01-13      791.1111 Thursday</span></span>
<span><span class="co">#&gt;  5: 2022-01-17      551.7701   Monday</span></span>
<span><span class="co">#&gt;  6: 2022-01-20      643.9910 Thursday</span></span>
<span><span class="co">#&gt;  7: 2022-01-24      741.9150   Monday</span></span>
<span><span class="co">#&gt;  8: 2022-01-27      770.1810 Thursday</span></span>
<span><span class="co">#&gt;  9: 2022-01-31      627.1725   Monday</span></span>
<span><span class="co">#&gt; 10: 2022-02-03      561.2913 Thursday</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="flows">Flows<a class="anchor" aria-label="anchor" href="#flows"></a>
</h5>
<p>The <code>flows</code> data tracks the daily flow (in mL/day) at the treatment plant in Zurich. The flow data will be used to normalize the concentration measurements. This helps to account for environmental factors such as rainfall. It is important that the flow uses the same volume unit as the concentration (mL here in both cases).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_zurich</span><span class="op">$</span><span class="va">flows</span></span>
<span><span class="co">#&gt;            date        flow</span></span>
<span><span class="co">#&gt;   1: 2022-01-01 3.41163e+11</span></span>
<span><span class="co">#&gt;   2: 2022-01-02 3.41163e+11</span></span>
<span><span class="co">#&gt;   3: 2022-01-03 1.58972e+11</span></span>
<span><span class="co">#&gt;   4: 2022-01-04 1.60849e+11</span></span>
<span><span class="co">#&gt;   5: 2022-01-05 3.72301e+11</span></span>
<span><span class="co">#&gt;  ---                       </span></span>
<span><span class="co">#&gt; 116: 2022-04-26 3.30659e+11</span></span>
<span><span class="co">#&gt; 117: 2022-04-27 2.06046e+11</span></span>
<span><span class="co">#&gt; 118: 2022-04-28 1.58373e+11</span></span>
<span><span class="co">#&gt; 119: 2022-04-29 1.52156e+11</span></span>
<span><span class="co">#&gt; 120: 2022-04-30 2.08685e+11</span></span></code></pre></div>
<p>❗ Note: It’s not a problem if you only have flow data on dates with measurements. However, for each measured date, there must also be a flow value. If flow information is missing for measured dates, please make sure to impute it using a suitable method before passing it to <code>EpiSewer</code> (or drop those dates).</p>
</div>
<div class="section level5">
<h5 id="cases">Cases<a class="anchor" aria-label="anchor" href="#cases"></a>
</h5>
<p>Finally, if we have case data available, we can also pass this to <code>EpiSewer.</code> This is then used to calibrate the model so that the estimated number of infections approximately matches the observed number of cases.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_zurich</span><span class="op">$</span><span class="va">cases</span></span>
<span><span class="co">#&gt;            date     cases</span></span>
<span><span class="co">#&gt;   1: 2022-01-01        NA</span></span>
<span><span class="co">#&gt;   2: 2022-01-02        NA</span></span>
<span><span class="co">#&gt;   3: 2022-01-03 1519.5313</span></span>
<span><span class="co">#&gt;   4: 2022-01-04 1727.3722</span></span>
<span><span class="co">#&gt;   5: 2022-01-05 1638.5321</span></span>
<span><span class="co">#&gt;  ---                     </span></span>
<span><span class="co">#&gt; 116: 2022-04-26  211.9338</span></span>
<span><span class="co">#&gt; 117: 2022-04-27  214.9822</span></span>
<span><span class="co">#&gt; 118: 2022-04-28  206.2498</span></span>
<span><span class="co">#&gt; 119: 2022-04-29  151.9567</span></span>
<span><span class="co">#&gt; 120: 2022-04-30  134.8545</span></span></code></pre></div>
<p>If you don’t have case data: don’t worry! In general, the assumed shedding load per case does not have a large effect on the effective reproduction number, and <code>EpiSewer</code> will use a robust default. You just have to keep in mind that the absolute number of infections estimated by <code>EpiSewer</code> should <strong>not be interpreted as true incidence or prevalence</strong>.</p>
</div>
</div>
<div class="section level4">
<h4 id="gather-the-data">Gather the data<a class="anchor" aria-label="anchor" href="#gather-the-data"></a>
</h4>
<p>We combine the <code>measurements</code> data and <code>flow</code> data using the helper function <code><a href="reference/sewer_data.html">sewer_data()</a></code>. We here use our artificially sparse measurements (only Mondays and Thursdays). For calibration purposes, we also supply the case data, as explained above.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sewer_data.html">sewer_data</a></span><span class="op">(</span></span>
<span>  measurements <span class="op">=</span> <span class="va">measurements_sparse</span>,</span>
<span>  flows <span class="op">=</span> <span class="va">data_zurich</span><span class="op">$</span><span class="va">flows</span>,</span>
<span>  cases <span class="op">=</span> <span class="va">data_zurich</span><span class="op">$</span><span class="va">cases</span> <span class="co"># cases are optional</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="assumptions">Assumptions<a class="anchor" aria-label="anchor" href="#assumptions"></a>
</h3>
<p>In order to estimate the effective reproduction number from wastewater concentration measurements, we have to make a number of assumptions.</p>
<ul>
<li>
<strong>Generation time distribution</strong>: Distribution of the time between a primary infection and its resulting secondary infections</li>
<li>
<strong>Shedding load distribution</strong>: Distribution of the load shed by an average individual over time. We also specify that our distribution is relative to the day of symptom onset.</li>
<li>
<strong>Incubation period distribution</strong>: Because our shedding load distribution is in <em>days since symptom onset</em>, we also need to make an assumption about the time between infection and symptom onset.</li>
</ul>
<p>The generation time, shedding load and incubation period distribution are all disease-specific and are typically obtained from literature. <code>EpiSewer</code> requires these distributions to be discretized, and offers specific functions to obtain discretized versions of popular continuous probability distributions.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_assumptions</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sewer_assumptions.html">sewer_assumptions</a></span><span class="op">(</span></span>
<span>  generation_dist <span class="op">=</span> <span class="fu"><a href="reference/get_discrete_gamma_shifted.html">get_discrete_gamma_shifted</a></span><span class="op">(</span>gamma_mean <span class="op">=</span> <span class="fl">3</span>, gamma_sd <span class="op">=</span> <span class="fl">2.4</span>, maxX <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>  shedding_dist <span class="op">=</span> <span class="fu"><a href="reference/get_discrete_gamma.html">get_discrete_gamma</a></span><span class="op">(</span>gamma_shape <span class="op">=</span> <span class="fl">0.929639</span>, gamma_scale <span class="op">=</span> <span class="fl">7.241397</span>, maxX <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>,</span>
<span>  shedding_reference <span class="op">=</span> <span class="st">"symptom_onset"</span>, <span class="co"># shedding load distribution is relative to symptom onset</span></span>
<span>  incubation_dist <span class="op">=</span> <span class="fu"><a href="reference/get_discrete_gamma.html">get_discrete_gamma</a></span><span class="op">(</span>gamma_shape <span class="op">=</span> <span class="fl">8.5</span>, gamma_scale <span class="op">=</span> <span class="fl">0.4</span>, maxX <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span><span class="op">)</span></span></code></pre></div>
<p>💡 Sometimes, shedding load distributions are instead specified in <em>days since infection</em>. In that case, you can use <code>shedding_reference = "infection"</code> and don’t need to supply an incubation period distribution.</p>
</div>
<div class="section level3">
<h3 id="estimation">Estimation<a class="anchor" aria-label="anchor" href="#estimation"></a>
</h3>
<p>Now that we have the data and necessary assumptions, we can use <code>EpiSewer</code> to estimate the effective reproduction number. We here use the default model and settings provided by <code>EpiSewer</code>. With the helper function <code><a href="reference/set_fit_opts.html">set_fit_opts()</a></code> we specify our sampling approach: we apply Hamiltonian MCMC sampling via stan, using 4 chains with 500 warmup and 500 sampling iterations each.</p>
<p>Stan regularly provides updates about the progress of the sampler. The overall runtime will depend on your hardware resources, the size of the data, the complexity of the model used, and how well the model actually fits the data. On a MacBook Pro (2 GHz Quad-Core Intel Core i5) the example below takes about 4 minutes to run.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="co"># allow stan to use 4 cores, i.e. one for each chain</span></span>
<span><span class="va">ww_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/EpiSewer.html">EpiSewer</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">ww_data</span>,</span>
<span>  assumptions <span class="op">=</span> <span class="va">ww_assumptions</span>,</span>
<span>  fit_opts <span class="op">=</span> <span class="fu"><a href="reference/set_fit_opts.html">set_fit_opts</a></span><span class="op">(</span>sampler <span class="op">=</span> <span class="fu"><a href="reference/sampler_stan_mcmc.html">sampler_stan_mcmc</a></span><span class="op">(</span></span>
<span>    iter_warmup <span class="op">=</span> <span class="fl">500</span>, iter_sampling <span class="op">=</span> <span class="fl">500</span>, chains <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">42</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>💡 We are here using a shorthand version of the <code><a href="reference/EpiSewer.html">EpiSewer()</a></code> function which uses all available default settings. To find out how the <code>EpiSewer</code> model can be customized, see the <a href="https://adrian-lison.github.io/EpiSewer/articles/model-specification.html">model specification</a> and <a href="https://adrian-lison.github.io/EpiSewer/articles/detailed-example.html">detailed example</a> vignettes.</p>
</div>
<div class="section level3">
<h3 id="plotting-the-results">Plotting the results<a class="anchor" aria-label="anchor" href="#plotting-the-results"></a>
</h3>
<p>Great, the sampling has completed! Now we can inspect the results of our model. Plots are a convenient way to get a quick overview.</p>
<div class="section level4">
<h4 id="model-fit">Model fit<a class="anchor" aria-label="anchor" href="#model-fit"></a>
</h4>
<p>It is good practice to first assess how well the model actually fitted to the data. For this, we plot the observed concentration measurements against the ones predicted by the model. The inner and outer ribbons show the 50% and 95% credible intervals. The black dots show measurements that we have actually observed in our artificially sparse data set (only Mondays and Thursdays). The grey crosses show all the other measurements that were not available to the model. As we can see, the model still achieved a decent fit on these missing days.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/plot_concentration.html">plot_concentration</a></span><span class="op">(</span><span class="va">ww_result</span>, measurements <span class="op">=</span> <span class="va">data_zurich</span><span class="op">$</span><span class="va">measurements</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-concentration-1.png" width="100%"></p>
<p>By default, the function <code><a href="reference/plot_concentration.html">plot_concentration()</a></code> shows absolute concentrations, which strongly depend on the daily wastewater flow. Alternatively, we can plot the flow-normalized concentration by setting <code>normalized = TRUE</code>. This will show the hypothetical concentration if the flow was at its median value. For this option, we need to provide the flow data as well (see below).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/plot_concentration.html">plot_concentration</a></span><span class="op">(</span><span class="va">ww_result</span>, measurements <span class="op">=</span> <span class="va">data_zurich</span><span class="op">$</span><span class="va">measurements</span>, flows <span class="op">=</span> <span class="va">data_zurich</span><span class="op">$</span><span class="va">flows</span>, normalized <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-concentration_normalized-1.png" width="100%"> As can be seen, the normalization removes the noise due to the daily variation of flow. The remaining uncertainty is due to the measurement noise and other sources of variation.</p>
</div>
<div class="section level4">
<h4 id="time-varying-effective-reproduction-number">Time-varying effective reproduction number<a class="anchor" aria-label="anchor" href="#time-varying-effective-reproduction-number"></a>
</h4>
<p>Since the model fit looked decent at first glance, we now inspect our main parameter of interest, the effective reproduction number over time. Again, the ribbons show the 50% and 95% credible intervals. We see that even with only two measurements per week, we get a fairly clear signal for R being above or below the critical threshold of 1.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/plot_R.html">plot_R</a></span><span class="op">(</span><span class="va">ww_result</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-R-1.png" width="100%"></p>
<p>Note that the estimates for R go back further into the past than our observations. This is due to the delay from infection to shedding, i.e. concentration measurements observed today are mostly a signal of infections in the past. This is also why the R estimates close to the present are strongly uncertain. The measurements observed until the present provide only a delayed signal about transmission dynamics, so the most recent R estimates are informed by only little data.</p>
</div>
<div class="section level4">
<h4 id="growth-report">Growth report<a class="anchor" aria-label="anchor" href="#growth-report"></a>
</h4>
<p>We can also display a growth report which shows the probability that infections have been growing for a prolonged period of time. By default, <code>EpiSewer</code> selects the most recent date for which reliable estimates are possible as a reference.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/plot_growth_report.html">plot_growth_report</a></span><span class="op">(</span><span class="va">ww_result</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-growth_report-1.png" width="100%"> As the model was fitted at the end of the seasonal wave in Zurich, there is high posterior support that infections are currently not growing for a prolonged period of time.</p>
<p>You can also display a growth report for other dates. Let’s for example have a look at the report for mid-February 2022. Here we can see that there is strong posterior support that infections have been growing for at least a week. At the same time, it seems rather unlikely that they have already been growing for 3 weeks or longer.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/plot_growth_report.html">plot_growth_report</a></span><span class="op">(</span><span class="va">ww_result</span>, date <span class="op">=</span> <span class="st">"2022-02-19"</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-growth_report2-1.png" width="100%"></p>
<p>💡 <code>EpiSewer</code> also provides further indicators of transmission dynamics, see e.g. <code><a href="reference/plot_growth_rate.html">plot_growth_rate()</a></code> and <code><a href="reference/plot_doubling_time.html">plot_doubling_time()</a></code>. These can however be more volatile and sometimes difficult to interpret.</p>
</div>
<div class="section level4">
<h4 id="latent-parameters">Latent parameters<a class="anchor" aria-label="anchor" href="#latent-parameters"></a>
</h4>
<p>We can also inspect other internal parameters of the model. This may give us a better understanding of the model fit and may help to diagnose certain problems.</p>
<p>First, we plot the estimated load over time. This is the expected total load that arrived at the sampling side on a given day. We can see this is roughly on the order 1e14 to 3e14.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/plot_load.html">plot_load</a></span><span class="op">(</span><span class="va">ww_result</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-load-1.png" width="100%"> Next, we plot the estimated number of infections over time. The time series follows a very similar trend as the load. Compared to the load, the peak in infections seems to be a bit more spiked, and also a bit earlier. This is because infected individuals only begin shedding after their infection and then shed over a longer period of time (as defined by the incubation period and shedding load distribution). This makes the load a slightly delayed and blurred signal of the infections.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/plot_infections.html">plot_infections</a></span><span class="op">(</span><span class="va">ww_result</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-infections-1.png" width="100%"></p>
<p>Note that because we supplied case data, the estimated infections <em>rougly</em> match the case numbers (plotted in blue below). Nevertheless, the infections plot shown here should only be used for diagnostic purposes, for example to ensure that the trend looks sensible and that the scale of infections is not unrealistic (not millions of infections or 0.01 infections per day). Please do <strong>not</strong> interpret the estimated number of infections in terms of true absolute incidence or prevalence.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/plot_infections.html">plot_infections</a></span><span class="op">(</span><span class="va">ww_result</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_zurich</span><span class="op">$</span><span class="va">cases</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">cases</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"#000080"</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-infections_with_cases-1.png" width="100%"></p>
<p>We can also compare the prior and posterior distribution for certain parameters of the model to see how much they were informed by the data. For example, we can inspect the coefficient of variation (CV) of the observation noise:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/plot_prior_posterior.html">plot_prior_posterior</a></span><span class="op">(</span><span class="va">ww_result</span>, <span class="st">"measurement_noise_cv"</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-prior_posterior_noise_cv-1.png" width="100%"> As we can see, the prior (in grey) and posterior (in blue) differ substantially, indicating that this parameter is well informed by the data.</p>
</div>
</div>
<div class="section level3">
<h3 id="more-details">More details<a class="anchor" aria-label="anchor" href="#more-details"></a>
</h3>
<p>We can further inspect our results object. It has three attributes:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ww_result</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "job"         "stan_model"  "checksums"   "summary"     "fitted"     </span></span>
<span><span class="co">#&gt; [6] "diagnostics" "runtime"</span></span></code></pre></div>
<p>The <code>job</code> attribute stores all information about the job that was defined via <code>EpiSewer</code>. It contains the data used, alongside meta-information, and the settings for the sampler. By calling <code>run(ww_result$job)</code>, the job can be run again.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ww_result</span><span class="op">$</span><span class="va">job</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "job_name"      "jobarray_size" "data"          "model"        </span></span>
<span><span class="co">#&gt;  [5] "init"          "fit_opts"      "results_opts"  "priors_text"  </span></span>
<span><span class="co">#&gt;  [9] "metainfo"      "overwrite"</span></span></code></pre></div>
<p>In particular, we can print a concise summary of the modeling details (the <code>EpiSewer</code> defaults in this case):</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_result</span><span class="op">$</span><span class="va">job</span><span class="op">$</span><span class="va">model</span></span>
<span><span class="co">#&gt; measurements</span></span>
<span><span class="co">#&gt;  |- concentrations_observe</span></span>
<span><span class="co">#&gt;  |- noise_estimate</span></span>
<span><span class="co">#&gt;  |- LOD_none</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; sampling</span></span>
<span><span class="co">#&gt;  |- sample_effects_none</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; sewage</span></span>
<span><span class="co">#&gt;  |- flows_observe</span></span>
<span><span class="co">#&gt;  |- residence_dist_assume</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; shedding</span></span>
<span><span class="co">#&gt;  |- incubation_dist_assume</span></span>
<span><span class="co">#&gt;  |- shedding_dist_assume (shedding_reference = symptom_onset)</span></span>
<span><span class="co">#&gt;  |- load_per_case_calibrate</span></span>
<span><span class="co">#&gt;  |- load_variation_estimate</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; infections</span></span>
<span><span class="co">#&gt;  |- generation_dist_assume</span></span>
<span><span class="co">#&gt;  |- R_estimate_splines</span></span>
<span><span class="co">#&gt;  |- seeding_estimate_rw</span></span>
<span><span class="co">#&gt;  |- infection_noise_estimate (overdispersion = TRUE)</span></span></code></pre></div>
<p>➡️ Check out the <a href="https://adrian-lison.github.io/EpiSewer/articles/model-specification.html">model specification</a> and <a href="https://adrian-lison.github.io/EpiSewer/articles/detailed-example.html">detailed example</a> vignettes to better understand the modeling details and customize the <code>EpiSewer</code> model.</p>
<p>The <code>summary</code> attribute stores summarized results for important parameters from the model.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ww_result</span><span class="op">$</span><span class="va">summary</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "samples"                  "R"                       </span></span>
<span><span class="co">#&gt;  [3] "expected_infections"      "infections"              </span></span>
<span><span class="co">#&gt;  [5] "growth_rate"              "doubling_time"           </span></span>
<span><span class="co">#&gt;  [7] "days_growing"             "expected_load"           </span></span>
<span><span class="co">#&gt;  [9] "expected_concentration"   "concentration"           </span></span>
<span><span class="co">#&gt; [11] "normalized_concentration"</span></span></code></pre></div>
<p>For example, we can access the exact estimates for the reproduction number.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ww_result</span><span class="op">$</span><span class="va">summary</span><span class="op">$</span><span class="va">R</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;          date     mean   median lower_0.95 lower_0.5 upper_0.5 upper_0.95</span></span>
<span><span class="co">#&gt; 1: 2021-12-06 1.049711 1.044085  0.7324020 0.9372597  1.152850   1.395459</span></span>
<span><span class="co">#&gt; 2: 2021-12-07 1.050463 1.042825  0.7470177 0.9427265  1.150043   1.380040</span></span>
<span><span class="co">#&gt; 3: 2021-12-08 1.051356 1.041470  0.7572534 0.9485155  1.150755   1.377987</span></span>
<span><span class="co">#&gt; 4: 2021-12-09 1.052399 1.044530  0.7605042 0.9530230  1.149892   1.369603</span></span>
<span><span class="co">#&gt; 5: 2021-12-10 1.053602 1.047620  0.7645480 0.9585617  1.151843   1.366598</span></span>
<span><span class="co">#&gt;        type seeding</span></span>
<span><span class="co">#&gt; 1: estimate    TRUE</span></span>
<span><span class="co">#&gt; 2: estimate    TRUE</span></span>
<span><span class="co">#&gt; 3: estimate    TRUE</span></span>
<span><span class="co">#&gt; 4: estimate    TRUE</span></span>
<span><span class="co">#&gt; 5: estimate    TRUE</span></span></code></pre></div>
<p>The <code>fitted</code> attribute provides access to all details of the fitted stan model (see <a href="https://mc-stan.org/cmdstanr/reference/CmdStanMCMC.html" class="external-link">cmdstanr</a> for details). For example, we can use this to show sampler diagnostics for each chain:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_result</span><span class="op">$</span><span class="va">fitted</span><span class="op">$</span><span class="fu">diagnostic_summary</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $num_divergent</span></span>
<span><span class="co">#&gt; [1] 0 0 0 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $num_max_treedepth</span></span>
<span><span class="co">#&gt; [1] 0 0 0 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $ebfmi</span></span>
<span><span class="co">#&gt; [1] 1.0296476 0.9815957 1.0001229 0.8657642</span></span></code></pre></div>
<p>Finally, the <code>checksums</code> attribute gives us several checksums that uniquely identify the job which was run. These can be used to check whether two job results used the same or different models, input data, fitting options, or inits. If all checksums are identical (and the seed is not <code>NULL</code>), then the results should also be identical.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_result</span><span class="op">$</span><span class="va">checksums</span></span>
<span><span class="co">#&gt; $model</span></span>
<span><span class="co">#&gt; [1] "6346549bd7c2ac9a9d200503d7356a29"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $input</span></span>
<span><span class="co">#&gt; [1] "fd1bc664ef6320ad9f8427d3a0f3d18c"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $fit_opts</span></span>
<span><span class="co">#&gt; [1] "5309bbbc3cd1cc109eac60d2fc82de45"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $results_opts</span></span>
<span><span class="co">#&gt; [1] "e92f83d0ca5d22b3bb5849d62c5412ee"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $init</span></span>
<span><span class="co">#&gt; [1] "30505348d747504aa36fe8fb6bdfaaf3"</span></span></code></pre></div>
</div>
</div>
</div>

  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/adrian-lison/EpiSewer/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/adrian-lison/EpiSewer/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>

<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing EpiSewer</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Adrian Lison <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-6822-8437" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Adrian Lison.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
