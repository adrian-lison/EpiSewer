<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Detailed example • EpiSewer</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Detailed example">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">EpiSewer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Introduction</h6></li>
    <li><a class="dropdown-item" href="../articles/model-specification.html">Modeling in EpiSewer</a></li>
    <li><a class="dropdown-item" href="../articles/detailed-example.html">Detailed example</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Modeling details</h6></li>
    <li><a class="dropdown-item" href="../articles/model-definition.html">Model definition</a></li>
    <li><a class="dropdown-item" href="../articles/load_per_case.html">The "shedding load per case" assumption</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/adrian-lison/EpiSewer/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Detailed example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/adrian-lison/EpiSewer/blob/main/vignettes/detailed-example.Rmd" class="external-link"><code>vignettes/detailed-example.Rmd</code></a></small>
      <div class="d-none name"><code>detailed-example.Rmd</code></div>
    </div>

    
    
<p>This vignette repeats the introductory example from the <a href="../index.html">README</a>, but shows how to specify the different
modules and components in <code>EpiSewer</code> explicitly.</p>
<p>💡 For a conceptual overview over modules and components, we
recommend to first read the <code><a href="../articles/model-specification.html">vignette("model-specification")</a></code>
vignette.</p>
<div class="section level3">
<h3 id="loading-the-package">Loading the package<a class="anchor" aria-label="anchor" href="#loading-the-package"></a>
</h3>
<p>We assume that <code>EpiSewer</code> is already successfully
installed (see <a href="../index.html">README</a>: installing the
package).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://adrian-lison.github.io/EpiSewer/">EpiSewer</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<p>This is again the wastewater data from Zurich, Switzerland, provided
by EAWAG (Swiss Federal Institute of Aquatic Science and
Technology).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_zurich</span> <span class="op">&lt;-</span> <span class="va">SARS_CoV_2_Zurich</span></span></code></pre></div>
<p>As in the introductory example, we keep only measurements that were
made on Mondays and Thursdays to test <code>EpiSewer</code> on sparse
data.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">measurements_sparse</span> <span class="op">&lt;-</span> <span class="va">data_zurich</span><span class="op">$</span><span class="va">measurements</span><span class="op">[</span>,<span class="va">weekday</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html" class="external-link">weekdays</a></span><span class="op">(</span><span class="va">data_zurich</span><span class="op">$</span><span class="va">measurements</span><span class="op">$</span><span class="va">date</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="va">weekday</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Monday"</span>,<span class="st">"Thursday"</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">measurements_sparse</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;           date concentration  weekday</span></span>
<span><span class="co">#&gt;         &lt;Date&gt;         &lt;num&gt;   &lt;char&gt;</span></span>
<span><span class="co">#&gt;  1: 2022-01-03      455.7580   Monday</span></span>
<span><span class="co">#&gt;  2: 2022-01-06      330.7298 Thursday</span></span>
<span><span class="co">#&gt;  3: 2022-01-10      387.6885   Monday</span></span>
<span><span class="co">#&gt;  4: 2022-01-13      791.1111 Thursday</span></span>
<span><span class="co">#&gt;  5: 2022-01-17      551.7701   Monday</span></span>
<span><span class="co">#&gt;  6: 2022-01-20      643.9910 Thursday</span></span>
<span><span class="co">#&gt;  7: 2022-01-24      741.9150   Monday</span></span>
<span><span class="co">#&gt;  8: 2022-01-27      770.1810 Thursday</span></span>
<span><span class="co">#&gt;  9: 2022-01-31      627.1725   Monday</span></span>
<span><span class="co">#&gt; 10: 2022-02-03      561.2913 Thursday</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="modeling">Modeling<a class="anchor" aria-label="anchor" href="#modeling"></a>
</h3>
<p>In the <a href="../index.html">README</a>, we used a shortcut to
collect all observation data via <code><a href="../reference/sewer_data.html">sewer_data()</a></code> and all
assumptions via <code><a href="../reference/sewer_assumptions.html">sewer_assumptions()</a></code>. These are convenience
functions to make the <code>EpiSewer</code> command more concise. In
this example however, we will explicitly supply the data and assumptions
to the relevant modules and components (see the
<code><a href="../articles/model-specification.html">vignette("model-specification")</a></code> vignette).</p>
<div class="section level4">
<h4 id="measurements">Measurements<a class="anchor" aria-label="anchor" href="#measurements"></a>
</h4>
<p>We start with the first module, the observed measurements. The module
can be specified as follows:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_measurements</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_measurements.html">model_measurements</a></span><span class="op">(</span></span>
<span>  concentrations <span class="op">=</span> <span class="fu"><a href="../reference/concentrations_observe.html">concentrations_observe</a></span><span class="op">(</span>measurements <span class="op">=</span> <span class="va">measurements_sparse</span><span class="op">)</span>,</span>
<span>  noise <span class="op">=</span> <span class="fu"><a href="../reference/noise_estimate.html">noise_estimate</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  LOD <span class="op">=</span> <span class="fu"><a href="../reference/LOD_none.html">LOD_none</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>As we see, the module is defined using the
<code><a href="../reference/model_measurements.html">model_measurements()</a></code> function. The arguments of this
function represent the different module components. In this case, there
is:</p>
<ul>
<li>a <code>concentrations</code> component: defines pathogen
concentrations in the wastewater</li>
<li>a <code>noise</code> component: defines measurement noise</li>
<li>a <code>LOD</code> component: defines a limit of detection in
wastewater samples</li>
</ul>
<p>We used a specific modeling function for each of the components. The
suffix of each function explains what we modeled:</p>
<ul>
<li>
<code>concentrations_observe</code>: The concentrations are modeled
as observation data to which the model can be fitted.</li>
<li>
<code>noise_estimate</code>: The degree of measurement noise is
estimated from the data.</li>
<li>
<code>LOD_none</code>: We do not model a limit of detection. This
also means that zero measurements are dropped.</li>
</ul>
<p>We can also print the module object to see what we have modeled:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_measurements</span></span>
<span><span class="co">#&gt; measurements</span></span>
<span><span class="co">#&gt;  |- concentrations_observe</span></span>
<span><span class="co">#&gt;  |- noise_estimate</span></span>
<span><span class="co">#&gt;  |- LOD_none</span></span></code></pre></div>
<p>❗ Note that the modeling functions above have further arguments, and
<code>EpiSewer</code> will use default settings if they are not
specified. For example, we could set a custom prior on the measurement
noise as follows:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_measurements2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_measurements.html">model_measurements</a></span><span class="op">(</span></span>
<span>  concentrations <span class="op">=</span> <span class="fu"><a href="../reference/concentrations_observe.html">concentrations_observe</a></span><span class="op">(</span>measurements <span class="op">=</span> <span class="va">measurements_sparse</span><span class="op">)</span>,</span>
<span>  noise <span class="op">=</span> <span class="fu"><a href="../reference/noise_estimate.html">noise_estimate</a></span><span class="op">(</span>cv_prior_mu <span class="op">=</span> <span class="fl">0.5</span>, cv_prior_sigma <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>, <span class="co"># prior on coefficient of variation</span></span>
<span>  LOD <span class="op">=</span> <span class="fu"><a href="../reference/LOD_none.html">LOD_none</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>➡️ To find out which options are available for a given modeling
function, check out its function documentation.</p>
<p>Before we move to the next module, remember that there can be
multiple modeling options for a component, and <code>EpiSewer</code>
offers one modeling function for each option. To see all available
options, you can use <code><a href="../reference/component_functions.html">component_functions()</a></code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/component_functions.html">component_functions</a></span><span class="op">(</span><span class="st">"LOD"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "LOD_none()"          "LOD_assume()"        "LOD_estimate_dPCR()"</span></span></code></pre></div>
<p>For example, we could assume a limit of detection of
<code>2.56 gc/mL</code> (based on a lab experiment by EAWAG, this was
the lowest concentration at which still 95% of replicates were positive)
as follows:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_measurements3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_measurements.html">model_measurements</a></span><span class="op">(</span></span>
<span>  concentrations <span class="op">=</span> <span class="fu"><a href="../reference/concentrations_observe.html">concentrations_observe</a></span><span class="op">(</span>measurements <span class="op">=</span> <span class="va">measurements_sparse</span><span class="op">)</span>,</span>
<span>  noise <span class="op">=</span> <span class="fu"><a href="../reference/noise_estimate.html">noise_estimate</a></span><span class="op">(</span>cv_prior_mu <span class="op">=</span> <span class="fl">0.5</span>, cv_prior_sigma <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>, <span class="co"># prior on coefficient of variation</span></span>
<span>  LOD <span class="op">=</span> <span class="fu"><a href="../reference/LOD_assume.html">LOD_assume</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fl">2.56</span>, prob <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>If our measurements are based on digital PCR (dPCR), we can also
model the LOD with an explicit model of dPCR noise. Note that we also
have to adapt the noise component accordingly.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_measurements4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_measurements.html">model_measurements</a></span><span class="op">(</span></span>
<span>  concentrations <span class="op">=</span> <span class="fu"><a href="../reference/concentrations_observe.html">concentrations_observe</a></span><span class="op">(</span>measurements <span class="op">=</span> <span class="va">measurements_sparse</span><span class="op">)</span>,</span>
<span>  noise <span class="op">=</span> <span class="fu"><a href="../reference/noise_estimate_dPCR.html">noise_estimate_dPCR</a></span><span class="op">(</span><span class="op">)</span>, <span class="co"># also model dPCR noise</span></span>
<span>  LOD <span class="op">=</span> <span class="fu"><a href="../reference/LOD_estimate_dPCR.html">LOD_estimate_dPCR</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="sampling">Sampling<a class="anchor" aria-label="anchor" href="#sampling"></a>
</h4>
<p>Next is the <code>sampling</code> module. It models the process of
sampling from the wastewater:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_sampling</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_sampling.html">model_sampling</a></span><span class="op">(</span></span>
<span>  outliers <span class="op">=</span> <span class="fu"><a href="../reference/outliers_none.html">outliers_none</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  sample_effects <span class="op">=</span> <span class="fu"><a href="../reference/sample_effects_none.html">sample_effects_none</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The sampling module currently has two component. The outlier
component allows to automatically detect outlier observations during
model fitting, making transmission dynamic estimates more robust. The
sample effects component allows to model the effects of sample
characteristics (like time from sampling until processing, which can
lead to degradation) on the detectable pathogen concentrations. In this
simple example, we do not model outliers or sampling effects.</p>
</div>
<div class="section level4">
<h4 id="sewage">Sewage<a class="anchor" aria-label="anchor" href="#sewage"></a>
</h4>
<p>The <code>sewage</code> module describes aspects of the sewage
system:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_sewage</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_sewage.html">model_sewage</a></span><span class="op">(</span></span>
<span>  flows <span class="op">=</span> <span class="fu"><a href="../reference/flows_observe.html">flows_observe</a></span><span class="op">(</span>flows <span class="op">=</span> <span class="va">data_zurich</span><span class="op">$</span><span class="va">flows</span><span class="op">)</span>,</span>
<span>  residence_dist <span class="op">=</span> <span class="fu"><a href="../reference/residence_dist_assume.html">residence_dist_assume</a></span><span class="op">(</span>residence_dist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>It includes two components:</p>
<ul>
<li>
<code>flows</code>: Daily flow volumes at the sampling site. Here we
use the measured flows at the treatment plant in Zurich, specified using
<code><a href="../reference/flows_observe.html">flows_observe()</a></code>.</li>
<li>
<code>residence_dist</code>: Sewer residence time distribution for
pathogen particles. In large sewage systems, particles may travel longer
than a day depending on where and when they were shed into the
wastewater. This component allows to model the corresponding delay
distribution. We here use the modeling function
<code><a href="../reference/residence_dist_assume.html">residence_dist_assume()</a></code> to indicate that we make an
assumption about the residence time. In our case, we assume that
particles arrive at the sampling site within the same day (indicated by
the vector <code>c(1)</code>, which puts 100% probability on a residence
time of 0 days).</li>
</ul>
</div>
<div class="section level4">
<h4 id="shedding">Shedding<a class="anchor" aria-label="anchor" href="#shedding"></a>
</h4>
<p>The <code>shedding</code> module describes how infected individuals
shed pathogen particles into the wastewater:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_shedding</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_shedding.html">model_shedding</a></span><span class="op">(</span></span>
<span>  shedding_dist <span class="op">=</span> <span class="fu"><a href="../reference/shedding_dist_assume.html">shedding_dist_assume</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/get_discrete_gamma.html">get_discrete_gamma</a></span><span class="op">(</span>gamma_shape <span class="op">=</span> <span class="fl">0.929639</span>, gamma_scale <span class="op">=</span> <span class="fl">7.241397</span><span class="op">)</span>, shedding_reference <span class="op">=</span> <span class="st">"symptom_onset"</span><span class="op">)</span>,</span>
<span>  incubation_dist <span class="op">=</span> <span class="fu"><a href="../reference/incubation_dist_assume.html">incubation_dist_assume</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_discrete_gamma.html">get_discrete_gamma</a></span><span class="op">(</span>gamma_shape <span class="op">=</span> <span class="fl">8.5</span>, gamma_scale <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  load_per_case <span class="op">=</span> <span class="fu"><a href="../reference/load_per_case_calibrate.html">load_per_case_calibrate</a></span><span class="op">(</span>cases <span class="op">=</span> <span class="va">data_zurich</span><span class="op">$</span><span class="va">cases</span><span class="op">)</span>,</span>
<span>  load_variation <span class="op">=</span> <span class="fu"><a href="../reference/load_variation_estimate.html">load_variation_estimate</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The shedding module requires a number of assumptions (see
explanations in the <a href="../index.html">README</a>):</p>
<ul>
<li>
<code>shedding_dist</code> and <code>incubation_dist</code>: We use
the same shedding load distribution (by days since symptom onset) as
before. We also need to assume an incubation period distribution.</li>
<li>
<code>load_per_case</code>: The load per case assumption is
calibrated based on observed case data. In the <a href="../index.html">README</a>, we supplied the case data via
<code><a href="../reference/sewer_data.html">sewer_data()</a></code>. Here, we now supply it directly to
<code><a href="../reference/load_per_case_calibrate.html">load_per_case_calibrate()</a></code>.</li>
<li>
<code>load_variation</code>: <code>EpiSewer</code> offers the option
to model individual-level variation in shedding, and this is recommended
as a default.</li>
</ul>
</div>
<div class="section level4">
<h4 id="infections">Infections<a class="anchor" aria-label="anchor" href="#infections"></a>
</h4>
<p>The <code>infections</code> module describes the underlying process
leading to infected individuals:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_infections</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_infections.html">model_infections</a></span><span class="op">(</span></span>
<span>  generation_dist <span class="op">=</span> <span class="fu"><a href="../reference/generation_dist_assume.html">generation_dist_assume</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_discrete_gamma_shifted.html">get_discrete_gamma_shifted</a></span><span class="op">(</span>gamma_mean <span class="op">=</span> <span class="fl">3</span>, gamma_sd <span class="op">=</span> <span class="fl">2.4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  R <span class="op">=</span> <span class="fu"><a href="../reference/R_estimate_splines.html">R_estimate_splines</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  seeding <span class="op">=</span> <span class="fu"><a href="../reference/seeding_estimate_rw.html">seeding_estimate_rw</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  infection_noise <span class="op">=</span> <span class="fu"><a href="../reference/infection_noise_estimate.html">infection_noise_estimate</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The module has the following epidemiological components:</p>
<ul>
<li>
<code>generation_dist</code>: We use the same generation time
distribution as before.</li>
<li>
<code>R</code>: This the effective reproduction number, our main
parameter of interest. We here estimate it via smoothing B-splines
(<code><a href="../reference/R_estimate_splines.html">R_estimate_splines()</a></code>), but there are other smoothing
approaches available (see <code>component_functions("R")</code>).</li>
<li>
<code>seeding</code>: The renewal model used by
<code>EpiSewer</code> requires a seeding phase during which the
reproduction number cannot be modeled. We thus let the initial
infections be estimated using a simple geometric random walk model.</li>
<li>
<code>infection_noise</code>: We also model noise in the infection
process, meaning that <code>EpiSewer</code> will fit a stochastic
infection model. This makes sense in most cases.</li>
</ul>
</div>
<div class="section level4">
<h4 id="forecast">Forecast<a class="anchor" aria-label="anchor" href="#forecast"></a>
</h4>
<p>Last but not least, there is the <code>forecast</code> module. This
module describes how the generative model defined by the other modules
is used to produce forecasts of Rt, infections, concentrations and other
quantities. By default, as in our <a href="../index.html">README</a>
example, we produce no forecasts by effectively setting the forecast
horizon to zero.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_forecast</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_forecast.html">model_forecast</a></span><span class="op">(</span></span>
<span>  horizon <span class="op">=</span> <span class="fu"><a href="../reference/horizon_none.html">horizon_none</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>If we want to produce forecasts, we can define the forecast horizon
(e.g. 7 days) as follows:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_forecast2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_forecast.html">model_forecast</a></span><span class="op">(</span></span>
<span>  horizon <span class="op">=</span> <span class="fu"><a href="../reference/horizon_assume.html">horizon_assume</a></span><span class="op">(</span>horizon <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The forecast module currently only has a single component to define
the forecast horizon. In the future, this may be extended to allow users
to customize how forecasts are obtained.</p>
</div>
<div class="section level4">
<h4 id="side-notes">Side notes<a class="anchor" aria-label="anchor" href="#side-notes"></a>
</h4>
<p>We have now specified all six <code>EpiSewer</code> modules. While
this seems like a lot of code, note that the majority of component
specifications are optional and have sensible defaults. In practice, you
only need to explicitly write out components that need certain
assumptions or that you want to customize. In the present example, we
also (unnecessarily) specified the <code>EpiSewer</code> defaults. For
example, the <code>infections</code> module described above could simply
be written as</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_infections</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_infections.html">model_infections</a></span><span class="op">(</span></span>
<span>  generation_dist <span class="op">=</span> <span class="fu"><a href="../reference/generation_dist_assume.html">generation_dist_assume</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_discrete_gamma_shifted.html">get_discrete_gamma_shifted</a></span><span class="op">(</span>gamma_mean <span class="op">=</span> <span class="fl">3</span>, gamma_sd <span class="op">=</span> <span class="fl">2.4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>because the <code>R</code>, <code>seeding</code>, and
<code>infection_noise</code> component used the defaults. No default is
given for the generation time distribution, since it is
pathogen-specific.</p>
<p>💡 An advantage of coding each component explicitly is that your
modeling decisions are clearly documented.</p>
</div>
</div>
<div class="section level3">
<h3 id="settings">Settings<a class="anchor" aria-label="anchor" href="#settings"></a>
</h3>
<p>Before starting the estimation, let’s have a quick look at some
settings for model fitting and post-processing.</p>
<p>The <code>fit_opts</code> settings describe how the model is fitted.
The first argument, <code>model</code> tells EpiSewer where to find the
<code>stan</code> files with the model code. The default is the
<code>EpiSewer</code> package itself, but you can also tweak this
setting to provide your own customized model files (see
<code><a href="../reference/model_stan_opts.html">model_stan_opts()</a></code> for details). The <code>sampler</code>
argument specifies the sampling algorithm used for model fitting.
Currently, only sampling via stan’s MCMC algorithm is supported. The
function <code><a href="../reference/sampler_stan_mcmc.html">sampler_stan_mcmc()</a></code> allows you to pass various
arguments to stan, including number of chains, iterations, and much
more.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_fit_opts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_fit_opts.html">set_fit_opts</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="fu"><a href="../reference/model_stan_opts.html">model_stan_opts</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"EpiSewer"</span><span class="op">)</span>,</span>
<span>  sampler <span class="op">=</span> <span class="fu"><a href="../reference/sampler_stan_mcmc.html">sampler_stan_mcmc</a></span><span class="op">(</span></span>
<span>    iter_warmup <span class="op">=</span> <span class="fl">500</span>,</span>
<span>    iter_sampling <span class="op">=</span> <span class="fl">500</span>,</span>
<span>    chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    parallel_chains <span class="op">=</span> <span class="fl">4</span>, <span class="co"># run all chains in parallel</span></span>
<span>    seed <span class="op">=</span> <span class="fl">42</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The <code>results_opts</code> argument specifies what results to
return after model fitting. We specify <code>fitted=TRUE</code>, which
means that the whole fitted model object will be stored. Setting this to
<code>fitted=FALSE</code> saves memory - but certain things like
detailed diagnostics or extracting draws of additional parameters will
not be possible. We also specify that parameters of interest should be
summarized with 50% and 95% credible intervals (in addition to the mean
and median). Moreover, we want to explicitly store 50 posterior samples
for the Rt and infections time series (useful for spaghetti plots
etc.).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_results_opts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_results_opts.html">set_results_opts</a></span><span class="op">(</span></span>
<span>  fitted <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  summary_intervals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.95</span><span class="op">)</span>,</span>
<span>  samples_ndraws <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="estimation">Estimation<a class="anchor" aria-label="anchor" href="#estimation"></a>
</h3>
<p>Now we have everything we need. To fit the model, we simply pass all
the EpiSewer modules and settings defined above to the
<code><a href="../reference/EpiSewer.html">EpiSewer()</a></code> function.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EpiSewer.html">EpiSewer</a></span><span class="op">(</span></span>
<span>  measurements <span class="op">=</span> <span class="va">ww_measurements</span>,</span>
<span>  sampling <span class="op">=</span> <span class="va">ww_sampling</span>,</span>
<span>  sewage <span class="op">=</span> <span class="va">ww_sewage</span>,</span>
<span>  shedding <span class="op">=</span> <span class="va">ww_shedding</span>,</span>
<span>  infections <span class="op">=</span> <span class="va">ww_infections</span>,</span>
<span>  forecast <span class="op">=</span> <span class="va">ww_forecast</span>,</span>
<span>  fit_opts <span class="op">=</span> <span class="va">ww_fit_opts</span>,</span>
<span>  results_opts <span class="op">=</span> <span class="va">ww_results_opts</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that this time we don’t need a <code>data</code> or
<code>assumptions</code> argument, because we provided all data and
assumptions to the respective module components.</p>
<p>The above model is identical to the default model fitted in the <a href="../index.html">README</a>, so we don’t repeat the results
again.</p>
<p>Remember that you can print a summary of the full modeling details
from the job object:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ww_result</span><span class="op">$</span><span class="va">job</span><span class="op">$</span><span class="va">model</span></span>
<span><span class="co">#&gt; measurements</span></span>
<span><span class="co">#&gt;  |- concentrations_observe</span></span>
<span><span class="co">#&gt;  |- noise_estimate</span></span>
<span><span class="co">#&gt;  |- LOD_none</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; sampling</span></span>
<span><span class="co">#&gt;  |- outliers_none</span></span>
<span><span class="co">#&gt;  |- sample_effects_none</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; sewage</span></span>
<span><span class="co">#&gt;  |- flows_observe</span></span>
<span><span class="co">#&gt;  |- residence_dist_assume</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; shedding</span></span>
<span><span class="co">#&gt;  |- incubation_dist_assume</span></span>
<span><span class="co">#&gt;  |- shedding_dist_assume</span></span>
<span><span class="co">#&gt;  |- load_per_case_calibrate</span></span>
<span><span class="co">#&gt;  |- load_variation_estimate</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; infections</span></span>
<span><span class="co">#&gt;  |- generation_dist_assume</span></span>
<span><span class="co">#&gt;  |- R_estimate_splines</span></span>
<span><span class="co">#&gt;  |- seeding_estimate_rw</span></span>
<span><span class="co">#&gt;  |- infection_noise_estimate (overdispersion = TRUE)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="full-model">Full model<a class="anchor" aria-label="anchor" href="#full-model"></a>
</h3>
<p>For your convenience, we here provide the full model using the
explicit component specifications in one code block. This can serve as a
starting point to adapt the specification and try out different modeling
options (check out the function documentation for the module functions,
or try out the <code><a href="../reference/component_functions.html">component_functions()</a></code> helper).</p>
<p>Also, don’t forget that the modeling functions have further arguments
to customize priors and other modeling details. As always, the function
documentation is your friend!</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">measurements_sparse</span> <span class="op">&lt;-</span> <span class="va">data_zurich</span><span class="op">$</span><span class="va">measurements</span><span class="op">[</span></span>
<span>  , <span class="va">weekday</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html" class="external-link">weekdays</a></span><span class="op">(</span><span class="va">data_zurich</span><span class="op">$</span><span class="va">measurements</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span>  <span class="op">]</span><span class="op">[</span><span class="va">weekday</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Monday"</span>,<span class="st">"Thursday"</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="va">ww_measurements</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_measurements.html">model_measurements</a></span><span class="op">(</span></span>
<span>  concentrations <span class="op">=</span> <span class="fu"><a href="../reference/concentrations_observe.html">concentrations_observe</a></span><span class="op">(</span>measurements <span class="op">=</span> <span class="va">measurements_sparse</span><span class="op">)</span>,</span>
<span>  noise <span class="op">=</span> <span class="fu"><a href="../reference/noise_estimate.html">noise_estimate</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  LOD <span class="op">=</span> <span class="fu"><a href="../reference/LOD_none.html">LOD_none</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ww_sampling</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_sampling.html">model_sampling</a></span><span class="op">(</span></span>
<span>  outliers <span class="op">=</span> <span class="fu"><a href="../reference/outliers_none.html">outliers_none</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  sample_effects <span class="op">=</span> <span class="fu"><a href="../reference/sample_effects_none.html">sample_effects_none</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ww_sewage</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_sewage.html">model_sewage</a></span><span class="op">(</span></span>
<span>  flows <span class="op">=</span> <span class="fu"><a href="../reference/flows_observe.html">flows_observe</a></span><span class="op">(</span>flows <span class="op">=</span> <span class="va">data_zurich</span><span class="op">$</span><span class="va">flows</span><span class="op">)</span>,</span>
<span>  residence_dist <span class="op">=</span> <span class="fu"><a href="../reference/residence_dist_assume.html">residence_dist_assume</a></span><span class="op">(</span>residence_dist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ww_shedding</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_shedding.html">model_shedding</a></span><span class="op">(</span></span>
<span>  shedding_dist <span class="op">=</span> <span class="fu"><a href="../reference/shedding_dist_assume.html">shedding_dist_assume</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_discrete_gamma.html">get_discrete_gamma</a></span><span class="op">(</span>gamma_shape <span class="op">=</span> <span class="fl">0.929639</span>, gamma_scale <span class="op">=</span> <span class="fl">7.241397</span><span class="op">)</span>, shedding_reference <span class="op">=</span> <span class="st">"symptom_onset"</span><span class="op">)</span>,</span>
<span>  incubation_dist <span class="op">=</span> <span class="fu"><a href="../reference/incubation_dist_assume.html">incubation_dist_assume</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_discrete_gamma.html">get_discrete_gamma</a></span><span class="op">(</span>gamma_shape <span class="op">=</span> <span class="fl">8.5</span>, gamma_scale <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  load_per_case <span class="op">=</span> <span class="fu"><a href="../reference/load_per_case_calibrate.html">load_per_case_calibrate</a></span><span class="op">(</span>cases <span class="op">=</span> <span class="va">data_zurich</span><span class="op">$</span><span class="va">cases</span><span class="op">)</span>,</span>
<span>  load_variation <span class="op">=</span> <span class="fu"><a href="../reference/load_variation_estimate.html">load_variation_estimate</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ww_infections</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_infections.html">model_infections</a></span><span class="op">(</span></span>
<span>  generation_dist <span class="op">=</span> <span class="fu"><a href="../reference/generation_dist_assume.html">generation_dist_assume</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_discrete_gamma_shifted.html">get_discrete_gamma_shifted</a></span><span class="op">(</span>gamma_mean <span class="op">=</span> <span class="fl">3</span>, gamma_sd <span class="op">=</span> <span class="fl">2.4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  R <span class="op">=</span> <span class="fu"><a href="../reference/R_estimate_splines.html">R_estimate_splines</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  seeding <span class="op">=</span> <span class="fu"><a href="../reference/seeding_estimate_rw.html">seeding_estimate_rw</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  infection_noise <span class="op">=</span> <span class="fu"><a href="../reference/infection_noise_estimate.html">infection_noise_estimate</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ww_forecast</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_forecast.html">model_forecast</a></span><span class="op">(</span></span>
<span>  horizon <span class="op">=</span> <span class="fu"><a href="../reference/horizon_none.html">horizon_none</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ww_fit_opts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_fit_opts.html">set_fit_opts</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="fu"><a href="../reference/model_stan_opts.html">model_stan_opts</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"EpiSewer"</span><span class="op">)</span>,</span>
<span>  sampler <span class="op">=</span> <span class="fu"><a href="../reference/sampler_stan_mcmc.html">sampler_stan_mcmc</a></span><span class="op">(</span></span>
<span>    iter_warmup <span class="op">=</span> <span class="fl">500</span>,</span>
<span>    iter_sampling <span class="op">=</span> <span class="fl">500</span>,</span>
<span>    chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    parallel_chains <span class="op">=</span> <span class="fl">4</span>, <span class="co"># run all chains in parallel</span></span>
<span>    seed <span class="op">=</span> <span class="fl">42</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ww_results_opts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_results_opts.html">set_results_opts</a></span><span class="op">(</span></span>
<span>  fitted <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  summary_intervals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.95</span><span class="op">)</span>,</span>
<span>  samples_ndraws <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ww_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EpiSewer.html">EpiSewer</a></span><span class="op">(</span></span>
<span>  measurements <span class="op">=</span> <span class="va">ww_measurements</span>,</span>
<span>  sampling <span class="op">=</span> <span class="va">ww_sampling</span>,</span>
<span>  sewage <span class="op">=</span> <span class="va">ww_sewage</span>,</span>
<span>  shedding <span class="op">=</span> <span class="va">ww_shedding</span>,</span>
<span>  infections <span class="op">=</span> <span class="va">ww_infections</span>,</span>
<span>  forecast <span class="op">=</span> <span class="va">ww_forecast</span>,</span>
<span>  fit_opts <span class="op">=</span> <span class="va">ww_fit_opts</span>,</span>
<span>  results_opts <span class="op">=</span> <span class="va">ww_results_opts</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Adrian Lison.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
